---
- include: mount_devices.yml

- include: configure_swap.yml
  when: swap_space is defined

- name: Install packages (CentOS)
  yum:
    state: present
    name:
      - docker
      - dstat
      - lsof
      - bash-completion
      - time
      - tmux
      - git
      - python-devel
      - openssl-devel
      - python-pip
      - sysstat
      - iptables-services
      - tmpwatch

- name: Enable iptables service (CentOS)
  service: name=iptables state=started enabled=yes

- name: Upload custom docker configuration (CentOS)
  template:
    src: etc/sysconfig/{{ item }}.j2
    dest: /etc/sysconfig/{{ item }}
    backup: True
  with_items:
    - docker-network
    - docker-storage-setup
  notify: restart docker

- name: Enable Docker service
  service: name=docker state=started enabled=yes

- name: create docker group
  group:
    name: docker
    state: present

- name: Add cloud-user to docker group and create ssh key
  user:
    name: cloud-user
    append: yes
    groups: docker
    generate_ssh_key: yes

- name: Create application root directory
  file: path={{ docker_host_app_root }} owner=cloud-user state=directory

- name: Create docker image directory
  file: path={{ docker_host_image_dir }} owner=cloud-user state=directory

- name: set iptables state file (CentOS)
  set_fact: iptables_state_file="/etc/sysconfig/iptables"
  when: ansible_lsb.id=="CentOS"

- name: Iptables rules to block access to the host from containers
  template:
    src=etc/sysconfig/iptables.j2
    dest={{ iptables_state_file }}
    backup=True
  notify:
    - restart iptables

- name: create backup script dir
  file:
    dest: ~cloud-user/backup_scripts/
    state: directory
  become_user: cloud-user

- name: add backup script to dir
  copy:
    dest: ~cloud-user/backup_scripts/backup.sh
    src: backup.sh
    owner: cloud-user
    mode: 0744

- name: disable auto-updates on Pouta
  file:
    name: /etc/cron.daily/automatic_updates
    state: absent
